@startuml Phase2b_Subsequent_Payments

!theme plain
autonumber

actor "Client" as Client
participant "Vendor API" as Vendor
database "Vendor DB\n(Redis)" as VendorDB

loop for each subsequent payment

    Client -> Client: Build payment payload\n    (mode-specific proof/signature)\n    (must advance channel state)
    Client -> Client: Sign payload

    Client -> Vendor: Submit Payment
    activate Vendor

    Vendor -> Vendor: Verify envelope and parse payload

    Vendor -> VendorDB: Load channel state
    VendorDB --> Vendor: channel + latest payment

    Vendor -> Vendor: Validate payment against channel state

    Vendor -> VendorDB: Update channel state\n(store latest payment)
    
    Vendor --> Client: 201 Created\n
    deactivate Vendor

end

@enduml
