@startuml Phase2b_Subsequent_Payments

!theme plain
autonumber

actor "Client" as Client
participant "Vendor API" as Vendor
database "Vendor DB\n(Redis)" as VendorDB

loop for each subsequent payment (i = 2 to 9_999)

    Client -> Client: Build OffChainTxPayload
    Client -> Client: Wrap payload in Envelope\n    signed with client private key

    Client -> Vendor: Submit Payment\n    Envelope<OffChainTxPayload>
    activate Vendor

    Vendor -> Vendor: Verify envelope &\ndeserialize payload

    Vendor -> VendorDB: Get Channel Aggregate\n(metadata + latest_tx)
    VendorDB --> Vendor: channel + previous_tx

    Vendor -> Vendor: Validate Payment + Channel

    Vendor -> VendorDB: UPDATE Channel Aggregate\n(set latest_tx)
    
    Vendor --> Client: 201 Created\n
    deactivate Vendor

end

@enduml
