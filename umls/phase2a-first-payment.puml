@startuml Phase2a_First_Payment

!theme plain
autonumber

actor "Client" as Client
participant "Vendor API" as Vendor
database "Vendor DB\n(Redis)" as VendorDB
participant "Issuer API" as Issuer
database "Issuer DB\n(Redis)" as IssuerDB

Client -> Client: Build OffChainTxPayload\n(computed_id, client_pk, vendor_pk, owed_amount)
Client -> Client: Wrap payload in Envelope\nsigned with client private key

Client -> Vendor: POST /api/v1/payments/receive\nEnvelope<OffChainTxPayload>
activate Vendor

Vendor -> Vendor: Verify envelope & deserialize payload

Vendor -> VendorDB: Get latest OffChainTx\nfor computed_id
VendorDB --> Vendor: none (first payment)

Vendor -> Issuer: GET /api/v1/issuer/payment-channel/{computed_id}
activate Issuer
Issuer -> IssuerDB: Get PaymentChannel from computed_id
IssuerDB --> Issuer: PaymentChannel
Issuer --> Vendor: PaymentChannel
deactivate Issuer

Vendor -> Vendor: Validate channel & payment\n(open, correct vendor_pk, owed_amount within amount)

Vendor -> VendorDB: Cache PaymentChannel locally

Vendor -> VendorDB: CREATE OffChainTx\n(latest state for channel)

Vendor --> Client: 201 Created\nOffChainTxSummary
deactivate Vendor

@enduml
