@startuml Phase2a_First_Payment

!theme plain
autonumber

actor "Client" as Client
participant "Vendor API" as Vendor
database "Vendor DB\n(Redis)" as VendorDB
participant "Issuer API" as Issuer
database "Issuer DB\n(Redis)" as IssuerDB

Client -> Client: Build payment payload\n(mode-specific proof/signature)
Client -> Client: Sign payload

Client -> Vendor: Submit Payment
activate Vendor

Vendor -> Vendor: Verify envelope and parse payload

Vendor -> VendorDB: Load channel state
VendorDB --> Vendor: none (cache miss)

Vendor -> Issuer: Fetch channel details (first payment)
activate Issuer
Issuer -> IssuerDB: Get PaymentChannel
IssuerDB --> Issuer: PaymentChannel
Issuer --> Vendor: PaymentChannel
deactivate Issuer

Vendor -> Vendor: Validate payment against channel

Vendor -> VendorDB: Cache channel state and latest payment

Vendor --> Client: 201 Created
deactivate Vendor

@enduml
