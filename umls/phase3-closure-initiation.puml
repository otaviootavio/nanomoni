@startuml Phase3a_Closure_Initiation

!theme plain
autonumber

actor "Client" as Client
participant "Vendor API" as Vendor
database "Vendor DB\n(Redis)" as VendorDB

Client -> Vendor: Request Channel Closure
activate Vendor

Vendor -> VendorDB: Load channel state
VendorDB --> Vendor: PaymentChannel + latest payment

Vendor -> Vendor: Validate latest payment and channel state

Vendor -> Vendor: Prepare settlement request)
Vendor -> Vendor: Sign settlement request

Vendor -> Issuer: Settle & Close Channel
activate Issuer

Issuer -> Issuer: Receive & validate envelope

Issuer -> IssuerDB: Get PaymentChannel (by channel_id)
IssuerDB --> Issuer: PaymentChannel

Issuer -> Issuer: Validate settlement

Issuer -> IssuerDB: Update Vendor Account
Issuer -> IssuerDB: Update Client Account
Issuer -> IssuerDB: Update PaymentChannel\nMark as closed

Issuer --> Vendor: 200 OK\nCloseChannelResponse
deactivate Issuer

Vendor -> VendorDB: UPDATE PaymentChannel\nMark as closed
Vendor --> Client: 204 No Content
deactivate Vendor

@enduml
