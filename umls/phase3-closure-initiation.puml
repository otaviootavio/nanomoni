@startuml Phase3a_Closure_Initiation

!theme plain
autonumber

actor "Client" as Client
participant "Vendor API" as Vendor
database "Vendor DB\n(Redis)" as VendorDB

Client -> Vendor: Request Channel Closure\nCloseChannelRequest
activate Vendor

Vendor -> VendorDB: Get PaymentChannel
VendorDB --> Vendor: PaymentChannel

Vendor -> VendorDB: Get latest OffChainTx
VendorDB --> Vendor: OffChainTx

Vendor -> Vendor: Validate channel & payments

Vendor -> Vendor: Build CloseChannelRequestPayload\nfrom latest OffChainTx
Vendor -> Vendor: Wrap payload in Envelope\nsigned with vendor private key

Vendor -> Issuer: Settle & Close Channel\nEnvelope<CloseChannelRequestPayload>
activate Issuer

Issuer -> Issuer: Receive & validate envelope

Issuer -> IssuerDB: Get PaymentChannel \nfrom computed_id
IssuerDB --> Issuer: PaymentChannel

Issuer -> Issuer: Validate settlement logic

Issuer -> IssuerDB: UPDATE vendor Account\nbalance += owed_amount
Issuer -> IssuerDB: UPDATE client Account\nbalance += (amount - owed_amount)
Issuer -> IssuerDB: UPDATE PaymentChannel\nMark as closed

Issuer --> Vendor: 200 OK\nCloseChannelResponse
deactivate Issuer

Vendor -> VendorDB: UPDATE PaymentChannel\nMark as closed
Vendor --> Client: 204 No Content
deactivate Vendor

@enduml
